#!/bin/bash
set -eo pipefail

echo "======================================================================================================================"
echo "======================================================================================================================"
echo "== Uninstalling existing tensorflow =="
echo "======================================================================================================================"
echo "======================================================================================================================"
pip uninstall -y tensorflow tensorflow-estimator tf-nightly || true

echo "======================================================================================================================"
echo "======================================================================================================================"
echo "== Installing Nvidia Repo =="
echo "======================================================================================================================"
echo "======================================================================================================================"
# Add NVIDIA package repositories
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/cuda-ubuntu1804.pin
wget http://developer.download.nvidia.com/compute/machine-learning/repos/ubuntu1804/x86_64/nvidia-machine-learning-repo-ubuntu1804_1.0.0-1_amd64.deb


mv cuda-ubuntu1804.pin /etc/apt/preferences.d/cuda-repository-pin-600
apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/7fa2af80.pub
add-apt-repository "deb https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/ /"
apt install --no-install-recommends --yes ./nvidia-machine-learning-repo-ubuntu1804_1.0.0-1_amd64.deb
rm -f ./nvidia-machine-learning-repo-ubuntu1804_1.0.0-1_amd64.deb

echo "======================================================================================================================"
echo "======================================================================================================================"
echo "== Updating =="
echo "======================================================================================================================"
echo "======================================================================================================================"
apt update

echo "======================================================================================================================"
echo "======================================================================================================================"
echo "== Installing cudnn8 + tensorRT =="
echo "======================================================================================================================"
echo "======================================================================================================================"
# Install development and runtime libraries (~4GB)
apt install --yes --no-install-recommends \
    libcudnn8=8.0.4.30-1+cuda11.0  \
    libcudnn8-dev=8.0.4.30-1+cuda11.0

echo "======================================================================================================================"
echo "======================================================================================================================"
echo "== Installing tensorflow =="
echo "======================================================================================================================"
echo "======================================================================================================================"
pip install -U tensorflow

echo "======================================================================================================================"
echo "======================================================================================================================"
echo "== Testing gpu availability                                      =="
echo "== This should print list of gpu devices available in the system =="
echo "======================================================================================================================"
echo "======================================================================================================================"
python -c "import tensorflow as tf; print(tf.config.list_physical_devices('GPU'))"

